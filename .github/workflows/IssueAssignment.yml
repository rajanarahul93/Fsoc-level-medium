name: Check User Assignments via Bot Command

on:
  issue_comment:
    types: [created]

jobs:
  check-bot-command:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
    env:
      BACKEND_URL: https://pullquestgithubbackend-1.onrender.com
    
    steps:
    - name: Check if comment mentions @pullquestai for assignment check
      id: check_command
      run: |
        comment_body="${{ github.event.comment.body }}"
        
        # Check if comment mentions @pullquestai and asks about assignments
        if [[ "$comment_body" == *"@pullquestai"* ]] && \
           [[ "$comment_body" =~ (how many issues|tell me|show|check|what issues|list issues).*(assigned to|for) ]]; then
          echo "trigger_action=true" >> $GITHUB_OUTPUT
          echo "âœ… Assignment check request detected!"
          
          # Extract username using regex - looking for @username pattern
          username=$(echo "$comment_body" | grep -oP '(?:assigned to|for) @\K[a-zA-Z0-9_-]+' | head -1)
          
          if [[ -z "$username" ]]; then
            echo "trigger_action=false" >> $GITHUB_OUTPUT
            echo "âŒ No username found in command"
          else
            echo "username=$username" >> $GITHUB_OUTPUT
            echo "ğŸ” Username: $username"
          fi
        else
          echo "trigger_action=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸  Not an assignment check request, skipping..."
        fi
    
    - name: Debug â€“ print extracted info
      if: steps.check_command.outputs.trigger_action == 'true'
      run: |
        echo "ğŸ” Issue/PR #  : ${{ github.event.issue.number }}"
        echo "ğŸ” Is PR?      : ${{ github.event.issue.pull_request != null }}"
        echo "ğŸ” Requester   : ${{ github.event.comment.user.login }}"
        echo "ğŸ” Username    : ${{ steps.check_command.outputs.username }}"
        echo "ğŸ” Repository  : ${{ github.event.repository.full_name }}"
        echo "ğŸ” Owner       : ${{ github.event.repository.owner.login }}"
        echo "ğŸ” Repo Name   : ${{ github.event.repository.name }}"
    
    - name: Build payload âœ POST to backend
      if: steps.check_command.outputs.trigger_action == 'true'
      run: |
        ISSUE_NUMBER=${{ github.event.issue.number }}
        USERNAME="${{ steps.check_command.outputs.username }}"
        
        # Assemble payload for assignment check
        payload=$(jq -n \
          --arg owner         "${{ github.event.repository.owner.login }}" \
          --arg repo          "${{ github.event.repository.name }}" \
          --arg assignedUser  "$USERNAME" \
          --argjson issueNumber  "$ISSUE_NUMBER" \
          '{
            owner: $owner,
            repo: $repo, 
            issueNumber: $issueNumber,
            assignedUser: $assignedUser
          }')
        
        echo "ğŸ“¦ Payload:"
        echo "$payload"
        
        response=$(curl --fail --show-error --silent \
          -X POST "$BACKEND_URL/api/hactoberfest/IssueAssigned" \
          -H "Content-Type: application/json" \
          --data-raw "$payload" \
          -w '\nHTTP %{http_code}\n' )
        
        echo "ğŸ” Response: $response"
    
    - name: React to comment
      if: steps.check_command.outputs.trigger_action == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.reactions.createForIssueComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            comment_id: context.payload.comment.id,
            content: 'eyes'
          });
    
    - name: Done
      if: steps.check_command.outputs.trigger_action == 'true'
      run: echo "âœ… Assignment check completed and comment posted"